<%- include('partials/header', { pageTitle, theme }) %>
<%- include('partials/nav') %>
<% const isAdmin = currentUser && currentUser.role === 'admin'; %>
<main id="main" class="layout dashboard">
  <section class="page-header dashboard-header">
    <div class="dashboard-header__intro">
      <h1>Dashboard</h1>
      <p>Mission control centre for Hope Turtles.</p>
    </div>
    <% if (dashboardUser) {
         const userFirstName =
           dashboardUser.first_name ||
           (dashboardUser.full_name ? dashboardUser.full_name.split(/\s+/u)[0] : null) ||
           (currentUser && currentUser.firstName) ||
           'Crew member';
         const lastLoginDisplay = dashboardUser.last_login
           ? new Date(dashboardUser.last_login).toLocaleString('en-US', {
               dateStyle: 'medium',
               timeStyle: 'short'
             })
           : 'Never';
    %>
      <aside class="dashboard-user-card" aria-label="Current user summary">
        <p class="dashboard-user-card__greeting">
          Logged in as <strong><%= userFirstName %></strong>
        </p>
        <ul class="dashboard-user-card__meta">
          <li>
            <span class="dashboard-user-card__label">Last login</span>
            <span class="dashboard-user-card__value"><%= lastLoginDisplay %></span>
          </li>
          <li>
            <span class="dashboard-user-card__label">Role</span>
            <span class="dashboard-user-card__value"><%= dashboardUser.role || 'user' %></span>
          </li>
          <li>
            <span class="dashboard-user-card__label">Buwana ID</span>
            <span class="dashboard-user-card__value"><%= dashboardUser.buwana_id %></span>
          </li>
        </ul>
      </aside>
    <% } %>
  </section>

  <% if (canViewUserStats && userStats) { %>
    <section class="panel user-stats-panel">
      <header class="panel-header">
        <div>
          <h2>User insights</h2>
          <p class="panel-subtitle">Quick look at the HopeTurtles crew.</p>
        </div>
        <a class="button ghost" href="/admin/users">Manage users</a>
      </header>
      <dl class="user-stats-grid">
        <div>
          <dt>Total users</dt>
          <dd><%= userStats.totalUsers %></dd>
        </div>
        <div>
          <dt>Active accounts</dt>
          <dd><%= userStats.activeUsers %></dd>
        </div>
        <div>
          <dt>Joined last 24 hours</dt>
          <dd><%= userStats.joinedLast24Hours %></dd>
        </div>
        <div>
          <dt>Suspended</dt>
          <dd><%= userStats.suspendedUsers %></dd>
        </div>
        <div>
          <dt>Admin team</dt>
          <dd><%= userStats.adminUsers %></dd>
        </div>
      </dl>
    </section>
  <% } %>

  <% if (isAdmin) { %>
    <section class="panel mission-management-panel" id="dashboard-missions">
      <header class="panel-header">
        <div>
          <h2>Mission management</h2>
          <p class="panel-subtitle">Overview of every mission and its assets.</p>
        </div>
        <button type="button" class="button" data-open-mission-form>Create mission</button>
      </header>
      <div class="table-wrapper">
        <table class="missions-table">
          <thead>
            <tr>
              <th scope="col">Name</th>
              <th scope="col">Status</th>
              <th scope="col">Bottles</th>
              <th scope="col">Turtles</th>
              <th scope="col">Boats</th>
            </tr>
          </thead>
          <tbody>
            <% missions.forEach(function (mission) { %>
              <tr>
                <td data-label="Name">
                  <strong><%= mission.name %></strong>
                  <% if (mission.description) { %>
                    <div class="muted"><%= mission.description %></div>
                  <% } %>
                </td>
                <td data-label="Status">
                  <span class="mission-status" data-status="<%= mission.status %>"><%= mission.status %></span>
                </td>
                <td data-label="Bottles" class="numeric-cell"><%= mission.bottle_count ?? 0 %></td>
                <td data-label="Turtles" class="numeric-cell"><%= mission.turtle_count ?? 0 %></td>
                <td data-label="Boats" class="numeric-cell"><%= mission.boat_count ?? 0 %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <% if (missions.length === 0) { %>
        <p class="panel-empty">No missions have been created yet.</p>
      <% } %>
    </section>

    <dialog id="createMissionDialog" class="mission-dialog" aria-labelledby="createMissionTitle">
      <form class="form-card admin-form mission-form" data-endpoint="/api/missions" data-method="POST">
        <header class="mission-dialog__header">
          <div>
            <h2 id="createMissionTitle">Create mission</h2>
            <p class="panel-subtitle">Define a new HopeTurtles deployment.</p>
          </div>
        </header>
        <div class="mission-form-grid">
          <label class="full-width">
            Name
            <input name="name" required />
          </label>
          <label class="full-width">
            Description
            <textarea name="description" rows="3"></textarea>
          </label>
          <label>
            Status
            <select name="status">
              <option value="planned">planned</option>
              <option value="active">active</option>
              <option value="paused">paused</option>
              <option value="completed">completed</option>
            </select>
          </label>
          <label>
            Start date
            <input type="datetime-local" name="start_date" />
          </label>
          <label>
            End date
            <input type="datetime-local" name="end_date" />
          </label>
          <label>
            Target latitude
            <input type="number" step="0.000001" name="target_lat" />
          </label>
          <label>
            Target longitude
            <input type="number" step="0.000001" name="target_lng" />
          </label>
        </div>
        <div class="mission-dialog__actions">
          <button type="button" class="button ghost" data-close-mission-form>Cancel</button>
          <button type="submit" class="button">Create mission</button>
        </div>
        <p class="form-feedback" role="status"></p>
      </form>
    </dialog>
  <% } %>

  <section class="metric-grid">
    <div class="metric-card">
      <h3>Missions</h3>
      <p class="metric-value"><%= missions.length %></p>
    </div>
    <div class="metric-card">
      <h3>Turtles</h3>
      <p class="metric-value"><%= turtles.length %></p>
    </div>
    <div class="metric-card">
      <h3>Recent successes</h3>
      <p class="metric-value"><%= successEntries.length %></p>
    </div>
  </section>

  <section class="dashboard-charts">
    <div class="chart-card">
      <h2>Status overview</h2>
      <canvas id="statusChart"></canvas>
    </div>
    <div class="chart-card">
      <h2>Telemetry rate (24h)</h2>
      <canvas id="telemetryChart"></canvas>
    </div>
  </section>

  <section class="dashboard-table">
    <h2>Live telemetry snapshot</h2>
    <table>
      <thead>
        <tr>
          <th>Turtle</th>
          <th>Latitude</th>
          <th>Longitude</th>
          <th>Battery</th>
          <th>Connection</th>
        </tr>
      </thead>
      <tbody>
        <% telemetry.forEach(function (item) { %>
          <tr>
            <td><%= item.turtle_id %></td>
            <td><%= item.latitude %></td>
            <td><%= item.longitude %></td>
            <td><%= item.battery_voltage %></td>
            <td><%= item.connection %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>

  <section class="alerts">
    <h2>Active alerts</h2>
    <ul>
      <% alerts.forEach(function (alert) { %>
        <li>
          <strong><%= alert.title %></strong> â€” <%= alert.message_body %>
        </li>
      <% }) %>
      <% if (alerts.length === 0) { %>
        <li>No active alerts.</li>
      <% } %>
    </ul>
  </section>
</main>
<% const pageScripts = [
  'https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js',
  '/js/dashboard.js'
]; %>
<% if (isAdmin) { pageScripts.push('/js/admin.js'); } %>
<%- include('partials/footer', { pageScripts }) %>

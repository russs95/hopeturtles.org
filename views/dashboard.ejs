<%- include('partials/header', { pageTitle, theme }) %>
<%- include('partials/nav') %>
<% const formatStatusKey = (value) => (value ? value.toLowerCase().replace(/[^a-z0-9]+/gu, '-') : ''); %>
<% const formatTurtleStatus = (value) => {
  if (!value) return 'Set status';
  return value
    .split(/_/gu)
    .filter(Boolean)
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}; %>
<% const turtleStatusOptions = ['awaiting_serial', 'idle', 'en_route', 'arrived', 'lost']; %>
<% const formatBottleStatus = (value) => {
  if (!value) return '‚Äî';
  return value
    .split(/\s+/gu)
    .filter(Boolean)
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}; %>
<% const formatWeight = (value) => {
  if (value === undefined || value === null || String(value).trim() === '') return '‚Äî';
  const numeric = Number(value);
  if (Number.isNaN(numeric)) return '‚Äî';
  return `${numeric.toLocaleString()} g`;
}; %>
<%
  const dashboardUserRecord = dashboardUser || currentUser || null;
  const userFirstName =
    dashboardUserRecord?.first_name ||
    (dashboardUserRecord?.full_name ? dashboardUserRecord.full_name.split(/\s+/u)[0] : null) ||
    (currentUser && currentUser.firstName) ||
    'Crew member';
  const userBuwanaId =
    dashboardUserRecord?.buwana_id ||
    (currentUser && (currentUser.buwanaId || currentUser.id)) ||
    null;
  const userEmoji = dashboardUserRecord?.earthling_emoji || 'üë§';
  const userRole = dashboardUserRecord?.role || 'user';
  const activeAlerts = Array.isArray(alerts) ? alerts : [];
  const hasActiveAlerts = activeAlerts.length > 0;
%>

<% if (dashboardUserRecord) { %>
  <section class="alert-user-info" aria-label="Current user">
    <div class="alert-user-info__inner">
      <div class="user-info__user-row" aria-label="Current user">
        <span class="alert-user-info__label">Logged in as</span>
        <a
          href="/profile"
          class="alert-user-info__user-link"
          <%= userBuwanaId ? `title="${userBuwanaId}"` : '' %>
        >
          <strong><%= userFirstName %></strong>
        </a>
        <span class="alert-user-info__divider" aria-hidden="true">|</span>
        <span class="alert-user-info__role"><%= userRole %></span>
        <span class="alert-user-info__divider" aria-hidden="true">|</span>
        <a href="/profile" class="alert-user-info__profile-link">
          edit <span aria-hidden="true"><%= userEmoji %></span> profile
        </a>
      </div>
    </div>
  </section>
<% } %>

<main id="main" class="layout dashboard">
  <section class="page-header dashboard-header">
    <section
      class="dashboard-alert-banner"
      aria-label="Active alerts"
      data-dashboard-alerts
      <%= hasActiveAlerts ? '' : 'hidden' %>
    >
      <ul class="dashboard-alert-banner__list" role="list">
        <% activeAlerts.forEach(function (alert) { %>
          <li class="dashboard-alert" data-dashboard-alert>
            <div class="dashboard-alert__body">
              <span class="dashboard-alert__emoji" aria-hidden="true"><%= alert.emoji || '‚ö†Ô∏è' %></span>
              <div>
                <strong class="dashboard-alert__title"><%= alert.title %></strong>
                <div class="dashboard-alert__message"><%= alert.message_body %></div>
              </div>
            </div>
            <button
              type="button"
              class="dashboard-alert__dismiss"
              aria-label="Dismiss alert"
              data-dashboard-alert-dismiss
            >&times;</button>
          </li>
        <% }) %>
      </ul>
    </section>

    <% const dashboardIntroCopy =
      t.dashboard_intro || 'Your mission control for launching and managing aid bottle and hope turtles on human to human missions.'; %>
    <div class="dashboard-header__intro">
      <h1>Dashboard</h1>
      <p><%= dashboardIntroCopy %></p>
    </div>
  </section>

  <% const myTurtles = Array.isArray(managedTurtles) ? managedTurtles : []; %>
  <% const activeHopeTurtles = myTurtles.filter(function (turtle) {
    return turtle && String(turtle.status || '').toLowerCase() !== 'lost';
  }); %>
  <% const myBottles = Array.isArray(userBottles) ? userBottles : []; %>
  <section class="panel my-bottles-panel" id="my-bottles">
    <header class="panel-header">
      <div>
        <h2>My Aid Bottles</h2>
        <p class="panel-subtitle">Bottles you've registered and packed for missions.</p>
      </div>
      <button type="button" class="button" data-open-register-bottle>+ Register Bottle</button>
    </header>
    <p class="form-feedback" role="status" data-my-bottles-feedback hidden></p>
    <div class="table-wrapper" data-my-bottles-table <%= myBottles.length ? '' : 'hidden' %>>
      <table class="bottles-table">
        <thead>
          <tr>
            <th scope="col">Aid Bottle</th>
            <th scope="col">Turtle</th>
            <th scope="col">Mission</th>
            <th scope="col">Contents</th>
            <th scope="col">Weight</th>
            <th scope="col">Verified</th>
            <th scope="col">Status</th>
          </tr>
        </thead>
        <tbody data-my-bottles-body>
          <% myBottles.forEach(function (bottle) { %>
            <tr
              data-bottle-row
              role="button"
              tabindex="0"
              aria-label="<%= bottle.serial_number
                ? 'Open delivery details for aid bottle #' + bottle.serial_number
                : 'Open delivery details for this aid bottle' %>"
              data-bottle-id="<%= bottle.bottle_id %>"
              data-serial-number="<%= bottle.serial_number || '' %>"
              data-hub-name="<%= bottle.hub_name || '' %>"
              data-hub-address="<%= bottle.hub_mailing_address || '' %>"
              data-turtle-id="<%= bottle.turtle_id || '' %>"
              data-turtle-name="<%= bottle.turtle_name || '' %>"
              data-hub-id="<%= bottle.hub_id || '' %>"
            >
              <td data-label="Aid Bottle">
                <div class="bottle-cell">
                  <div class="bottle-photo <%= bottle.basic_photo_url ? '' : 'bottle-photo--placeholder' %>">
                    <% if (bottle.basic_photo_url) { %>
                      <img
                        src="<%= bottle.basic_photo_url %>"
                        alt="Aid bottle <%= bottle.serial_number ? '#' + bottle.serial_number : 'photo' %>"
                        loading="lazy"
                      />
                    <% } else { %>
                      <span class="bottle-photo__placeholder">No photo</span>
                    <% } %>
                    <span class="bottle-photo__serial">
                      <%= bottle.serial_number ? '#' + bottle.serial_number : '‚Äî' %>
                    </span>
                  </div>
                </div>
              </td>
              <td data-label="Turtle">
                <% const turtleLabel = bottle.turtle_name || 'Assign turtle'; %>
                <button
                  type="button"
                  class="pill-button bottle-turtle-pill"
                  data-open-reassign-bottle
                  aria-label="Change turtle connection"
                >
                  <%= turtleLabel %>
                </button>
              </td>
              <td data-label="Mission"><%= bottle.mission_name || '‚Äî' %></td>
              <td data-label="Contents">
                <div class="bottle-contents"><%= bottle.contents || '‚Äî' %></div>
              </td>
              <td data-label="Weight"><%= formatWeight(bottle.weight_grams) %></td>
              <td data-label="Verified">
                <% const isBottleVerified = Number(bottle.verified) === 1 || bottle.verified === true; %>
                <span class="status-pill verified-pill" data-verified="<%= isBottleVerified ? 'true' : 'false' %>">
                  <%= isBottleVerified ? 'Verified' : 'Pending' %>
                </span>
              </td>
              <td data-label="Status">
                <span
                  class="status-pill bottle-status-pill"
                  data-status="<%= formatStatusKey(bottle.status) %>"
                  data-open-delivery-details
                >
                  <%= formatBottleStatus(bottle.status) %>
                </span>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <p class="panel-empty" data-my-bottles-empty <%= myBottles.length ? 'hidden' : '' %>>
      You haven't registered any bottles yet.
    </p>
  </section>

  <section class="panel my-turtles-panel" id="my-turtles">
    <header class="panel-header">
      <div>
        <h2>My Turtles</h2>
        <p class="panel-subtitle">Overview of the turtles you are managing.</p>
      </div>
      <button type="button" class="button" data-launch-turtle>+ Launch Turtle</button>
    </header>
    <% if (myTurtles.length > 0) { %>
      <div class="table-wrapper">
        <table class="turtles-table my-turtles-table">
          <thead>
            <tr>
              <th scope="col">Profile</th>
              <th scope="col">Name</th>
              <th scope="col">Mission</th>
              <th scope="col">Hub</th>
              <th scope="col">Boat</th>
              <th scope="col">Status</th>
              <th scope="col">Bottles</th>
            </tr>
          </thead>
          <tbody>
            <% myTurtles.forEach(function (turtle) { %>
              <tr
                role="button"
                tabindex="0"
                aria-label="Manage turtle <%= turtle.name || '#' + turtle.turtle_id %>"
                data-manageable-turtle
                data-turtle-id="<%= turtle.turtle_id %>"
                data-turtle-name="<%= turtle.name || '' %>"
                data-turtle-status="<%= turtle.status || '' %>"
                data-turtle-mission="<%= turtle.mission_id || '' %>"
              data-turtle-hub="<%= turtle.hub_id || '' %>"
              data-turtle-hub-name="<%= turtle.hub_name || '' %>"
              data-turtle-boat="<%= turtle.boat_id || '' %>"
              data-turtle-photo-url="<%= turtle.profile_photo_url || turtle.profile_photo_thumbnail_url || '' %>"
              data-turtle-photo-thumb-url="<%= turtle.profile_photo_thumbnail_url || '' %>"
              >
                <td data-label="Profile">
                  <div class="turtle-profile">
                    <div class="turtle-profile__photo">
                      <div class="turtle-profile__badge">
                        <span class="turtle-profile__badge-id">#<%= turtle.turtle_id %></span>
                        <% if (turtle.name) { %>
                          <span class="turtle-profile__badge-name"><%= turtle.name %></span>
                        <% } %>
                      </div>
                    <% const turtleDisplayPhoto = turtle.profile_photo_thumbnail_url || turtle.profile_photo_url; %>
                    <% if (turtleDisplayPhoto) { %>
                      <img
                        src="<%= turtleDisplayPhoto %>"
                        alt="Profile photo for <%= turtle.name || '#' + turtle.turtle_id %>"
                        loading="lazy"
                      />
                      <% } else { %>
                        <span class="turtle-profile__placeholder-text">#<%= turtle.turtle_id %></span>
                      <% } %>
                    </div>
                  </div>
                </td>
                <td data-label="Name"><%= turtle.name || '‚Äî' %></td>
              <td data-label="Mission"><%= turtle.mission_name || '‚Äî' %></td>
              <td data-label="Hub"><%= turtle.hub_name || '‚Äî' %></td>
              <td data-label="Boat"><%= turtle.boat_name || '‚Äî' %></td>
              <td data-label="Status">
                <button
                  type="button"
                  class="status-pill turtle-status-pill turtle-status-pill--action"
                  data-status="<%= formatStatusKey(turtle.status) %>"
                  data-trigger-manage-turtle
                >
                  <span aria-hidden="true">‚öôÔ∏è</span>
                  <span><%= formatTurtleStatus(turtle.status) %></span>
                </button>
              </td>
              <td data-label="Bottles">
                <button
                  type="button"
                  class="status-pill turtle-bottles-pill"
                  data-trigger-manage-bottles
                  aria-label="View bottles linked to <%= turtle.name || 'turtle #' + turtle.turtle_id %>"
                >
                  <span aria-hidden="true">üîó</span>
                  <span><%= Number(turtle.bottle_count || 0).toLocaleString() %></span>
                </button>
              </td>
            </tr>
          <% }) %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <p class="panel-empty">You aren't managing any turtles yet.</p>
    <% } %>
  </section>

  <%- include('partials/manage-turtle-dialog', { turtleStatusOptions, missions, hubs, boats }) %>

  <dialog id="turtleBottlesDialog" class="mission-dialog" aria-labelledby="turtleBottlesTitle">
    <article class="form-card turtle-bottles-card">
      <header class="mission-dialog__header">
        <div>
          <h2 id="turtleBottlesTitle">Connected bottles</h2>
          <p class="panel-subtitle" data-turtle-bottles-summary></p>
        </div>
        <button type="button" class="dialog-close" data-close-turtle-bottles aria-label="Close">&times;</button>
      </header>
      <p class="form-feedback" role="status" data-turtle-bottles-feedback hidden></p>
      <p class="panel-subtitle turtle-bottles-intro" data-turtle-bottles-intro></p>
      <ul class="turtle-bottles-list" data-turtle-bottles-list></ul>
      <p class="panel-empty" data-turtle-bottles-empty hidden>
        No bottles are currently connected to this turtle.
      </p>
    </article>
  </dialog>

  <dialog id="detachBottleConfirmDialog" class="mission-dialog" aria-labelledby="detachBottleTitle">
    <article class="form-card">
      <header class="mission-dialog__header">
        <div>
          <h3 id="detachBottleTitle">Remove bottle from turtle?</h3>
          <p class="panel-subtitle" data-detach-message>
            Are you sure you want to remove this bottle from this turtle? Later you can reassign the bottle to this turtle or
            another.
          </p>
        </div>
        <button type="button" class="dialog-close" data-close-detach-bottle aria-label="Close">&times;</button>
      </header>
      <div class="mission-dialog__actions mission-dialog__actions--danger">
        <button type="button" class="button ghost" data-cancel-detach-bottle>Keep bottle attached</button>
        <button type="button" class="button danger" data-confirm-detach-bottle>‚ùå Remove Bottle</button>
      </div>
      <p class="form-feedback" role="status" data-detach-feedback hidden></p>
    </article>
  </dialog>

  <dialog id="launchTurtleDialog" class="mission-dialog" aria-labelledby="launchTurtleTitle">
    <form class="form-card turtle-form" data-launch-turtle-form enctype="multipart/form-data">
      <header class="mission-dialog__header">
        <div>
          <h2 id="launchTurtleTitle">Launch turtle</h2>
          <p class="panel-subtitle">
            Register a turtle under your care and prepare it for deployment.
          </p>
        </div>
        <button type="button" class="dialog-close" data-close-launch-turtle aria-label="Close">&times;</button>
      </header>
      <div class="mission-form-grid">
        <label class="full-width">
          Turtle name
          <input name="name" required />
        </label>
        <label>
          Mission
          <select name="mission_id">
            <option value="">No mission assigned</option>
            <% missions.forEach(function (mission) { %>
              <option value="<%= mission.mission_id %>"><%= mission.name %></option>
            <% }) %>
          </select>
        </label>
        <label>
          Hub
          <select name="hub_id">
            <option value="">No hub assigned</option>
            <% hubs.forEach(function (hub) { %>
              <option value="<%= hub.hub_id %>"><%= hub.name %></option>
            <% }) %>
          </select>
        </label>
        <label>
          Boat
          <select name="boat_id">
            <option value="">No boat assigned</option>
            <% boats.forEach(function (boat) { %>
              <option value="<%= boat.boat_id %>"><%= boat.name %></option>
            <% }) %>
          </select>
        </label>
        <label class="full-width">
          Turtle's profile pic
          <input type="file" name="profile_photo" accept="image/*" />
          <span class="muted">Optional. Add a face to your new Hope Turtle.</span>
        </label>
      </div>
      <div class="mission-dialog__actions">
        <button type="button" class="button ghost" data-close-launch-turtle>Cancel</button>
        <button type="submit" class="button">Launch turtle</button>
      </div>
      <p class="form-feedback" role="status" data-launch-turtle-feedback></p>
    </form>
    <div class="form-card launch-success-state" data-launch-success hidden>
      <div class="launch-success-state__content">
        <div class="launch-success-state__ascii" aria-hidden="true">
          <pre class="brand-ascii launch-success-state__ascii-art" data-launch-success-ascii>HopeTurtles</pre>
        </div>
        <h1>Turtle launched!</h1>
        <p>
          Alright!  Your turtle is created.  Now, open the Manage panel to access this turtle secret key
          and hard code its rasberry pi config file.
        </p>
        <button type="button" class="button" data-launch-success-close>Got it!</button>
      </div>
    </div>
  </dialog>

  <dialog id="registerBottleDialog" class="mission-dialog" aria-labelledby="registerBottleTitle">
    <form class="form-card bottle-form" data-register-bottle-form>
      <header class="mission-dialog__header">
        <div>
          <h2 id="registerBottleTitle">Register Aid Bottle</h2>
          <p class="panel-subtitle">Log a new bottle in the system and link it to a mission.</p>
        </div>
        <button type="button" class="dialog-close" data-close-register-bottle aria-label="Close">&times;</button>
      </header>
      <div class="mission-form-grid">
        <div class="mission-form-grid__column-group">
          <label>
            Mission
            <select name="mission_id">
              <option value="">No mission assigned</option>
              <% missions.forEach(function (mission) { %>
                <option value="<%= mission.mission_id %>"><%= mission.name %></option>
              <% }) %>
            </select>
          </label>
          <label>
            Volume (ml)
            <input type="number" name="volume_ml" min="0" step="1" />
          </label>
          <label>
            Brand
            <input name="brand" />
          </label>
        </div>
        <label>
          Weight (grams)
          <input type="number" name="weight_grams" min="0" step="0.01" />
        </label>
        <label class="full-width">
          Contents
          <input
            type="text"
            name="contents"
            placeholder="List items packed inside the bottle"
            maxlength="255"
          />
        </label>
        <label class="full-width">
          Select the nearest hub to deliver your bottle too:
          <select name="hub_id" required>
            <option value="" disabled selected>Select a hub</option>
            <% hubs.forEach(function (hub) { %>
              <option value="<%= hub.hub_id %>"><%= hub.name %></option>
            <% }) %>
          </select>
        </label>
        <label class="full-width">
          If you are building your own turtle allocated this bottle to it:
          <select name="turtle_id">
            <option value="">No turtle selected</option>
            <% activeHopeTurtles.forEach(function (turtle) { %>
              <option value="<%= turtle.turtle_id %>"><%= turtle.name || ('Turtle #' + turtle.turtle_id) %></option>
            <% }) %>
          </select>
        </label>
      </div>
      <div class="mission-dialog__actions">
        <button type="button" class="button ghost" data-close-register-bottle>Cancel</button>
        <button type="submit" class="button">Register bottle</button>
      </div>
      <p class="form-feedback" role="status" data-register-bottle-feedback></p>
    </form>
  </dialog>

  <dialog
    id="bottleDeliveryDetailsDialog"
    class="mission-dialog"
    aria-labelledby="bottleDeliveryDetailsTitle"
  >
    <article class="form-card bottle-delivery-card">
      <header class="mission-dialog__header">
        <div>
          <h2 id="bottleDeliveryDetailsTitle">Bottle delivery details</h2>
        </div>
        <button
          type="button"
          class="dialog-close"
          data-close-bottle-delivery
          aria-label="Close"
        >
          &times;
        </button>
      </header>
      <form class="mission-dialog__form" data-bottle-delivery-form enctype="multipart/form-data">
        <div class="mission-form-grid">
          <p class="bottle-delivery-serial" data-bottle-delivery-serial>
            Please write your bottle's serial number using a permanent marker or nail polish:
            <strong class="bottle-delivery-serial__value" data-bottle-delivery-serial-value></strong>
          </p>
          <p data-bottle-delivery-hub hidden>
            Please ship your bottle to hub
            <strong data-bottle-delivery-hub-name></strong>
            at:
            <span data-bottle-delivery-hub-address></span>
          </p>
          <label class="full-width">
            Please upload a top to bottom photo of your bottle that shows its serial number clearly.
            <input type="file" name="bottle_basic_photo" accept="image/*" required />
          </label>
          <!-- <label class="full-width">
            Optional: Upload a selfie of you and your aid bottle to inspire others.
            <input type="file" name="bottle_selfie_photo" accept="image/*" />
          </label> -->
        </div>
        <div class="mission-dialog__actions mission-dialog__actions--split">
          <div class="mission-dialog__actions-group">
            <button type="button" class="button danger" data-delete-bottle>Delete</button>
          </div>
          <div class="mission-dialog__actions-group">
            <button type="button" class="button ghost" data-close-bottle-delivery>Cancel</button>
            <button type="submit" class="button" data-bottle-delivery-submit>Save</button>
          </div>
        </div>
        <p class="form-feedback" role="status" data-bottle-delivery-feedback hidden></p>
      </form>
    </article>
  </dialog>

  <dialog
    id="bottleCelebrationDialog"
    class="mission-dialog celebration-dialog"
    aria-labelledby="bottleCelebrationTitle"
  >
    <article class="form-card celebration-card">
      <header class="mission-dialog__header celebration-card__header">
        <div>
          <h2 id="bottleCelebrationTitle">Bottle has been saved!</h2>
          <p class="panel-subtitle">
            After your bottle has arrived at a community hub it will be reviewed and its status updated.  Once on its way in a
            turtle we'll also update the status.
          </p>
        </div>
        <button
          type="button"
          class="dialog-close"
          data-close-bottle-celebration
          aria-label="Close celebration"
        >
          &times;
        </button>
      </header>
      <div class="celebration-card__body celebration-card__body--turtle">
        <div class="celebration-card__mascot" aria-hidden="true">
          <pre class="brand-ascii celebration-card__ascii" data-bottle-celebration-ascii>HopeTurtles</pre>
        </div>
      </div>
      <div class="mission-dialog__actions celebration-card__actions celebration-card__actions--center">
        <button type="button" class="button" data-close-bottle-celebration>Got it! üëå</button>
      </div>
    </article>
  </dialog>

  <dialog id="reassignBottleDialog" class="mission-dialog" aria-labelledby="reassignBottleTitle">
    <form class="form-card" data-reassign-bottle-form>
      <header class="mission-dialog__header">
        <div>
          <h2 id="reassignBottleTitle">Change turtle connection</h2>
          <p class="panel-subtitle" data-reassign-bottle-summary></p>
        </div>
        <button type="button" class="dialog-close" data-close-reassign-bottle aria-label="Close">&times;</button>
      </header>
      <p class="muted" data-reassign-bottle-hub></p>
      <label>
        Available turtles at this hub
        <select name="turtle_id" data-reassign-bottle-select required></select>
      </label>
      <p class="muted" data-reassign-bottle-empty hidden>
        You don't have any turtles assigned to this hub yet.
      </p>
      <div class="mission-dialog__actions">
        <button type="button" class="button ghost" data-close-reassign-bottle>Cancel</button>
        <button type="submit" class="button">Save</button>
      </div>
      <p class="form-feedback" role="status" data-reassign-bottle-feedback hidden></p>
    </form>
  </dialog>

  <section class="metric-grid">
    <div class="metric-card">
      <h3>Missions</h3>
      <p class="metric-value"><%= missions.length %></p>
    </div>
    <div class="metric-card">
      <h3>Turtles</h3>
      <p class="metric-value"><%= turtles.length %></p>
    </div>
    <div class="metric-card">
      <h3>Recent successes</h3>
      <p class="metric-value"><%= successEntries.length %></p>
    </div>
  </section>

  <section class="dashboard-charts">
    <div class="chart-card">
      <h2>Status overview</h2>
      <canvas id="statusChart"></canvas>
    </div>
    <div class="chart-card">
      <h2>Telemetry rate (24h)</h2>
      <canvas id="telemetryChart"></canvas>
    </div>
  </section>

  <section class="panel dashboard-table">
    <h2>Live telemetry</h2>
    <div class="table-wrapper dashboard-table__wrapper">
      <table>
        <thead>
          <tr>
            <th>Turtle</th>
            <th>Latitude</th>
            <th>Longitude</th>
            <th>Battery</th>
          </tr>
        </thead>
        <tbody>
          <% telemetry.forEach(function (item) { %>
            <tr>
              <td><%= item.turtle_id %></td>
              <td><%= item.latitude %></td>
              <td><%= item.longitude %></td>
              <td><%= item.battery_voltage %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </section>

</main>
<% const pageScripts = [
  'https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js',
  '/js/dashboard.js',
  '/js/managed-turtles.js'
]; %>
<%- include('partials/footer', { pageScripts }) %>

<% const resolvedPath = typeof currentPath === 'string' ? currentPath : ''; %>
<% const normalizedPath = (resolvedPath || '').replace(/\/+$/u, '') || '/'; %>
<% const onDashboardPage = normalizedPath === '/dashboard'; %>
<header class="site-header">
  <div class="brand">
    <a href="/" class="brand-link" aria-label="hopeTurtles.org home" title="HopeTurtles | a human2human project">
      <span class="sr-only">hopeTurtles.org</span>
      <pre
        class="brand-ascii"
        aria-hidden="true"
        data-logo-src="/turtles-ascii-logo.txt"
        data-logo-alt-src="/turtles-ascii-logo-2.txt"
      >
        HopeTurtles
      </pre>
      <script>
        (function () {
          const script = document.currentScript;
          const target =
            script && script.previousElementSibling && script.previousElementSibling.classList.contains('brand-ascii')
              ? script.previousElementSibling
              : document.querySelector('.brand-ascii[data-logo-src]');
          if (!target) return;
          const sources = [target.dataset.logoSrc, target.dataset.logoAltSrc].filter(Boolean);
          const fallback = 'HopeTurtles';

          const loadLogo = (src) =>
            fetch(src)
              .then((response) => (response.ok ? response.text() : Promise.reject()))
              .then((text) => text.replace(/\s+$/u, ''))
              .catch(() => null);

          const setContent = (text) => {
            target.textContent = text || fallback;
          };

          Promise.all(sources.map((src) => loadLogo(src))).then((logos) => {
            const frames = logos.filter(Boolean);
            if (!frames.length) {
              setContent(fallback);
              return;
            }

            let frameIndex = 0;
            let animationId = null;
            setContent(frames[0]);

            const hoverTarget = target.closest('a') || target;
            if (!hoverTarget) return;

            const startAnimation = () => {
              if (frames.length < 2 || animationId !== null) return;
              animationId = window.setInterval(() => {
                frameIndex = (frameIndex + 1) % frames.length;
                setContent(frames[frameIndex]);
              }, 400);
            };

            const stopAnimation = () => {
              if (animationId === null) return;
              window.clearInterval(animationId);
              animationId = null;
              frameIndex = 0;
              setContent(frames[frameIndex]);
            };

            hoverTarget.addEventListener('mouseenter', startAnimation);
            hoverTarget.addEventListener('mouseleave', stopAnimation);
            hoverTarget.addEventListener('focus', startAnimation, true);
            hoverTarget.addEventListener('blur', stopAnimation, true);
          });
        })();
      </script>
      <span class="brand-wordmark-text" aria-hidden="true">
        hope<strong class="brand-wordmark-emphasis">Turtles</strong>.org
      </span>
    </a>
  </div>
  <nav class="primary-nav" aria-label="Primary">
    <a href="/missions"><%= t.nav_missions || t.nav_mission || 'Missions' %></a>
    <a href="/report">Reports</a>
    <a href="/about">About</a>
    <a href="/team"><%= t.nav_team || 'Team' %></a>
    <% if (currentUser && currentUser.role === 'admin') { %>
      <a href="/admin">Admin</a>
    <% } %>
  </nav>
  <div class="nav-controls">
    <div class="lang-menu">
      <button
        id="languageButton"
        class="lang-button"
        type="button"
        aria-haspopup="listbox"
        aria-expanded="false"
        aria-controls="languageMenu"
      >
        <span class="sr-only">Change language</span>
        <span aria-hidden="true" class="lang-button-icon">üåê</span>
      </button>
      <ul id="languageMenu" class="lang-options" role="listbox" hidden>
        <% languages.forEach(function (option) { %>
          <li role="none">
            <button
              type="button"
              role="option"
              data-lang="<%= option.code %>"
              class="lang-option"
              aria-selected="<%= option.code === lang %>"
            >
              <span class="lang-option-code"><%= option.code.toUpperCase() %></span>
              <span class="lang-option-label"><%= option.label %></span>
            </button>
          </li>
        <% }) %>
      </ul>
    </div>
    <button
      id="themeToggle"
      class="theme-toggle"
      aria-label="<%= theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode' %>"
      aria-pressed="<%= theme === 'dark' ? 'true' : 'false' %>"
      type="button"
    >
      <span class="theme-icon" aria-hidden="true"><%= theme === 'dark' ? '‚òÄÔ∏è' : 'üåô' %></span>
      <span class="sr-only"><%= theme === 'dark' ? 'Activate light theme' : 'Activate dark theme' %></span>
    </button>
    <button
      id="mobileMenuToggle"
      class="nav-controls__menu-toggle"
      type="button"
      aria-label="Open menu"
      aria-expanded="false"
      aria-controls="mobileMenu"
    >
      <span aria-hidden="true">üê¢</span>
      <span class="sr-only">Open menu</span>
    </button>
    <% if (currentUser) { %>
      <% if (!onDashboardPage) { %>
        <a class="button" href="/dashboard">üéÆ Dash</a>
      <% } %>
    <% } else { %>
      <a class="button nav-auth" href="<%= loginUrl %>">Login</a>
      <a
        class="button ghost nav-signup nav-auth"
        href="https://buwana.ecobricks.org/en/signup-1.php?app=hope_8fc3caabded4"
        target="_blank"
        rel="noreferrer"
      >
        Signup
      </a>
    <% } %>
  </div>
</header>
<div id="mobileMenu" class="mobile-menu" hidden>
  <div class="mobile-menu__backdrop" data-close-menu="true"></div>
  <div class="mobile-menu__panel">
    <button id="mobileMenuClose" class="mobile-menu__close" type="button" aria-label="Close menu">‚úï</button>
    <nav class="mobile-menu__nav" aria-label="Mobile primary">
      <a href="/missions"><%= t.nav_missions || t.nav_mission || 'Missions' %></a>
      <a href="/report">Reports</a>
      <a href="/about">About</a>
      <a href="/team"><%= t.nav_team || 'Team' %></a>
      <% if (currentUser && currentUser.role === 'admin') { %>
        <a href="/admin">Admin</a>
      <% } %>
      <% if (!currentUser) { %>
        <div class="mobile-menu__auth-links">
          <a class="button ghost mobile-menu__action" href="<%= loginUrl %>">Login</a>
          <a
            class="button ghost mobile-menu__action"
            href="https://buwana.ecobricks.org/en/signup-1.php?app=hope_8fc3caabded4"
            target="_blank"
            rel="noreferrer"
          >
            Signup
          </a>
        </div>
      <% } %>
    </nav>
    <div class="mobile-menu__footer">
      <% if (currentUser) {
           const userFirstName =
             currentUser.firstName ||
             (currentUser.name ? currentUser.name.split(/\s+/u)[0] : null) ||
             (currentUser.email ? currentUser.email.split('@')[0] : null) ||
             'Crew';
           const userEmoji = currentUser.earthlingEmoji || currentUser.earthling_emoji || 'üë§';
      %>
        <p class="mobile-menu__user">
          <span class="mobile-menu__user-emoji" aria-hidden="true"><%= userEmoji %></span>
          Logged in as <strong><%= userFirstName %></strong>
          <span class="mobile-menu__divider" aria-hidden="true">|</span>
          <a href="/profile">Edit Profile</a>
        </p>
      <% } %>
      <p class="mobile-menu__auth-note">
        Authentication by
        <a href="https://buwana.ecobricks.org" target="_blank" rel="noreferrer">Buwana</a>
      </p>
    </div>
  </div>
</div>

<% const extraStyles = ['https://unpkg.com/leaflet@1.9.4/dist/leaflet.css']; %>
<% const formatMissionDate = (value) => {
  if (!value) return '—';
  const date = new Date(value);
  if (Number.isNaN(date.getTime())) {
    return '—';
  }
  return date.toLocaleDateString('en-US', { dateStyle: 'medium' });
}; %>
<%- include('partials/header', { pageTitle, theme, extraStyles }) %>
<%- include('partials/nav') %>
<main id="main" class="layout mission-page">
  <section class="page-header mission-page__header">
    <div>
      <h1><%= t.missions_title || 'Missions Explorer' %></h1>
      <p><%= t.missions_intro || 'Browse every Hope Turtle mission and follow its target destination.' %></p>
    </div>
    <div class="filters">
      <label>
        <%= t.missions_filter_status || 'Status' %>
        <select id="missionFilter">
          <option value=""><%= t.missions_filter_all || 'All' %></option>
          <option value="planned"><%= t.missions_filter_planned || 'Planned' %></option>
          <option value="active"><%= t.missions_filter_active || 'Active' %></option>
          <option value="completed"><%= t.missions_filter_completed || 'Completed' %></option>
        </select>
      </label>
    </div>
  </section>

  <% if (!missions.length) { %>
    <p class="panel-empty"><%= t.missions_empty || 'No missions have been registered yet. Check back soon.' %></p>
  <% } else { %>
    <section class="mission-list" aria-live="polite">
      <% missions.forEach(function (mission) { %>
            <% const statusKey = (mission.status || 'unknown').toLowerCase(); %>
            <% const statusLabel = mission.status
          ? mission.status.charAt(0).toUpperCase() + mission.status.slice(1)
          : t.missions_status_unknown || 'Unknown'; %>
        <% const targetLat =
          mission.target_lat !== null && mission.target_lat !== undefined
            ? Number(mission.target_lat)
            : null; %>
        <% const targetLng =
          mission.target_lng !== null && mission.target_lng !== undefined
            ? Number(mission.target_lng)
            : null; %>
        <% const hasTarget = Number.isFinite(targetLat) && Number.isFinite(targetLng); %>
        <article
          class="card mission-card mission-card--explorer"
          id="mission-<%= mission.mission_id %>"
          data-status="<%= mission.status || '' %>"
          data-mission-card
        >
          <div
            class="mission-card__map <%= hasTarget ? '' : 'mission-card__map--empty' %>"
            <% if (hasTarget) { %>
              data-mission-map
              data-map-token="<%- mapboxToken %>"
              data-lat="<%- targetLat %>"
              data-lng="<%- targetLng %>"
              data-zoom="7.2"
            <% } %>
          >
            <% if (hasTarget) { %>
              <div
                id="missionCardMap-<%= mission.mission_id %>"
                class="map-canvas"
                aria-label="<%= t.missions_map_label || 'Mission target map for' %> <%= mission.name %>"
              ></div>
            <% } else { %>
              <p class="mission-card__map-placeholder"><%= t.missions_map_placeholder || 'Target coordinates coming soon' %></p>
            <% } %>
            <span class="status-pill status-<%= statusKey %>"><%= statusLabel %></span>
          </div>
          <div class="mission-card__body">
            <header class="card-header">
              <h2><%= mission.name %></h2>
              <p class="mission-card__dates">
                <strong><%= t.missions_start || 'Start' %>:</strong> <%= formatMissionDate(mission.start_date) %> ·
                <strong><%= t.missions_end || 'End' %>:</strong> <%= formatMissionDate(mission.end_date) %>
              </p>
            </header>
            <p><%= mission.description || t.missions_description_placeholder || 'Mission briefing to follow.' %></p>
          </div>
          <div class="mission-card__metrics">
            <div class="mission-metric">
              <span class="mission-metric__label"><%= t.missions_metric_turtles || 'Turtles' %></span>
              <span class="mission-metric__value"><%= Number(mission.turtle_count || 0).toLocaleString() %></span>
            </div>
            <div class="mission-metric">
              <span class="mission-metric__label"><%= t.missions_metric_hubs || 'Hubs' %></span>
              <span class="mission-metric__value"><%= Number(mission.hub_count || 0).toLocaleString() %></span>
            </div>
            <div class="mission-metric">
              <span class="mission-metric__label"><%= t.missions_metric_boats || 'Boats' %></span>
              <span class="mission-metric__value"><%= Number(mission.boat_count || 0).toLocaleString() %></span>
            </div>
            <div class="mission-metric">
              <span class="mission-metric__label"><%= t.missions_metric_bottles || 'Bottles' %></span>
              <span class="mission-metric__value"><%= Number(mission.bottle_count || 0).toLocaleString() %></span>
            </div>
          </div>
        </article>
      <% }) %>
    </section>
  <% } %>
</main>
<% const pageScripts = [
  'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',
  '/js/missions.js'
]; %>
<%- include('partials/footer', { pageScripts }) %>

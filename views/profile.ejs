<%- include('partials/header', { pageTitle, theme }) %>
<%- include('partials/nav') %>
<main class="layout profile-page">
  <section class="page-header profile-page__header">
    <div>
      <h1>Your profile</h1>
      <p>Review your Earthling identity and keep your public details current.</p>
    </div>
  </section>

  <section class="profile-grid">
    <article class="form-card profile-card">
      <div class="profile-card__header">
        <% const hasProfilePhoto = profileUser.profile_pic && profileUser.profile_pic !== 'null'; %>
        <div class="profile-avatar <%= hasProfilePhoto ? '' : 'profile-avatar--placeholder' %>">
          <% if (hasProfilePhoto) { %>
            <img
              src="<%= profileUser.profile_pic %>"
              alt="Profile photo for <%= profileUser.full_name || profileUser.first_name || 'your profile' %>"
              loading="lazy"
            />
          <% } else { %>
            <span aria-hidden="true"><%= profileUser.earthling_emoji || 'ðŸ‘¤' %></span>
          <% } %>
        </div>
        <div>
          <h2><%= profileUser.full_name || profileUser.first_name || 'Crew member' %></h2>
          <p class="profile-card__meta">
            Joined
            <%= profileUser.created_at
              ? new Date(profileUser.created_at).toLocaleDateString('en-US', { dateStyle: 'medium' })
              : 'â€”' %>
          </p>
        </div>
      </div>
      <dl class="profile-readonly-grid">
        <div class="readonly-field">
          <dt>First name</dt>
          <dd><%= profileUser.first_name || 'â€”' %></dd>
        </div>
        <div class="readonly-field">
          <dt>Last name</dt>
          <dd><%= profileUser.last_name || 'â€”' %></dd>
        </div>
        <div class="readonly-field">
          <dt>Username</dt>
          <dd><%= profileUser.username || 'â€”' %></dd>
        </div>
        <div class="readonly-field">
          <dt>Email</dt>
          <dd><%= profileUser.email || 'â€”' %></dd>
        </div>
        <div class="readonly-field">
          <dt>Role</dt>
          <dd><%= profileUser.role || 'user' %></dd>
        </div>
        <div class="readonly-field">
          <dt>Account status</dt>
          <dd><%= profileUser.account_status || 'active' %></dd>
        </div>
        <div class="readonly-field">
          <dt>Last login</dt>
          <dd>
            <%= profileUser.last_login
              ? new Date(profileUser.last_login).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' })
              : 'Never' %>
          </dd>
        </div>
        <div class="readonly-field">
          <dt>Login count</dt>
          <dd><%= Number(profileUser.login_count || 0).toLocaleString() %></dd>
        </div>
        <div class="readonly-field">
          <dt>Country / region</dt>
          <dd><%= profileUser.location_full || profileUser.country_id || 'â€”' %></dd>
        </div>
        <div class="readonly-field">
          <dt>Watershed</dt>
          <dd><%= profileUser.location_watershed || 'â€”' %></dd>
        </div>
        <% const continentCode = (profileUser.continent_code || '').toUpperCase(); %>
        <% const continentNames = {
             AF: 'ðŸŒ Africa',
             AN: 'ðŸŒ Antarctica',
             AS: 'ðŸŒ Asia',
             EU: 'ðŸŒ Europe',
             NA: 'ðŸŒŽ North America',
             SA: 'ðŸŒŽ South America',
             OC: 'ðŸŒŠ Oceania',
             AU: 'ðŸŒ Australia'
           }; %>
        <% const continentLabel = continentCode ? (continentNames[continentCode] || continentCode) : 'â€”'; %>
        <div class="readonly-field">
          <dt>Continent</dt>
          <dd><%= continentLabel %></dd>
        </div>
      </dl>
      <% const buwanaId = profileUser.buwana_id || profileUser.user_id || profileUser.id || ''; %>
      <% const hasBuwanaId = Boolean(buwanaId); %>
      <div class="profile-card__actions">
        <a
          class="button ghost"
          href="<%= hasBuwanaId
            ? `https://buwana.ecobricks.org/en/edit-profile.php?buwana=${encodeURIComponent(buwanaId)}&app=hope_8fc3caabded4`
            : '#' %>"
          <%= hasBuwanaId ? 'target="_blank" rel="noreferrer"' : 'aria-disabled="true"' %>
        >
          Edit Buwana Profile
        </a>
        <a
          class="button ghost"
          href="<%= `https://buwana.ecobricks.org/en/feedback.php?app=hope_8fc3caabded4${
            hasBuwanaId ? `&buwana=${encodeURIComponent(buwanaId)}` : ''
          }` %>"
          target="_blank"
          rel="noreferrer"
        >
          Bugs &amp; System Support
        </a>
      </div>
    </article>

    <form class="form-card profile-form" method="POST" action="/profile" enctype="multipart/form-data">
      <h2>Edit your public details</h2>
      <p class="profile-form__intro">
        Update the information other Buwana crew members see. Core identity fields such as your name and email are
        managed by the main registry.
      </p>
      <label>
        Profile title
        <input name="team_title" value="<%= profileUser.team_title || '' %>" placeholder="e.g. Turtle master" />
      </label>
      <label>
        Profile bio
        <textarea
          name="profile_txt"
          rows="5"
          placeholder="Share a short update about you, your mission, or your watershed community"
        ><%= profileUser.profile_txt || '' %></textarea>
      </label>
      <label>
        Profile photo
        <input type="file" name="profile_pic" accept="image/*" />
        <span class="muted">Supported formats: JPG, PNG, or WebP.</span>
      </label>
      <% if (profileFeedback && profileFeedback.message) { %>
        <p
          class="form-feedback <%= profileFeedback.type === 'error' ? 'is-error' : 'is-success' %>"
          role="status"
        >
          <%= profileFeedback.message %>
        </p>
      <% } %>
      <div class="mission-dialog__actions">
        <button type="submit" class="button">Save profile</button>
      </div>
    </form>
  </section>
</main>
<%- include('partials/footer') %>

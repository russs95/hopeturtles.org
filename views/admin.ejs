<%- include('partials/header', { pageTitle, theme }) %>
<%- include('partials/nav') %>
<% const formatStatusKey = (value) => (value ? value.toLowerCase().replace(/[^a-z0-9]+/gu, '-') : ''); %>
<% const formatDateTime = (value) =>
  value ? new Date(value).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' }) : 'â€”'; %>
<% const formatTurtleStatus = (value) => {
  if (!value) return 'Set status';
  return value
    .split(/_/gu)
    .filter(Boolean)
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}; %>
<% const formatDateTimeLocalValue = (value) => {
  if (!value) return '';
  const date = new Date(value);
  if (Number.isNaN(date.getTime())) {
    return '';
  }
  const localTime = new Date(date.getTime() - date.getTimezoneOffset() * 60000);
  return localTime.toISOString().slice(0, 16);
}; %>
<% const encodeRecord = (value) => encodeURIComponent(JSON.stringify(value)); %>
<% const formatWholeNumber = (value) => {
  if (value === undefined || value === null || value === '') return 'â€”';
  const numeric = Number(value);
  if (Number.isNaN(numeric)) return 'â€”';
  return Math.trunc(numeric).toLocaleString();
}; %>
<% const turtleStatusOptions = ['idle', 'en_route', 'arrived', 'lost']; %>
<% const defaultBoatStatus = 'Docked'; %>
<% const boatStatuses = [
  'Docked',
  'Deployed',
  'Deploying',
  'Sailing',
  'Loading',
  'Distress',
  'Captured',
  'Sunk'
]; %>
<% const boatManagerOptions = Array.isArray(users) ? users : []; %>
<% const turtlesForManagement = Array.isArray(turtleDetails) ? turtleDetails : []; %>
<% const adminAlerts = Array.isArray(alerts) ? alerts : []; %>
<main id="main" class="layout admin">
  <section class="page-header">
    <h1>Admin Tools</h1>
    <p>Manage missions, turtles, hubs, boats, and alerts.</p>
  </section>

  <% if (userStats) { %>
    <section class="panel user-stats-panel">
      <header class="panel-header">
        <div>
          <h2>User insights</h2>
          <p class="panel-subtitle">Quick look at the HopeTurtles crew.</p>
        </div>
        <a class="button ghost" href="/admin/users">Manage users</a>
      </header>
      <dl class="user-stats-grid">
        <div>
          <dt>Total users</dt>
          <dd><%= userStats.totalUsers %></dd>
        </div>
        <div>
          <dt>Active accounts</dt>
          <dd><%= userStats.activeUsers %></dd>
        </div>
        <div>
          <dt>Joined last 24 hours</dt>
          <dd><%= userStats.joinedLast24Hours %></dd>
        </div>
        <div>
          <dt>Suspended</dt>
          <dd><%= userStats.suspendedUsers %></dd>
        </div>
        <div>
          <dt>Admin team</dt>
          <dd><%= userStats.adminUsers %></dd>
        </div>
      </dl>
    </section>
  <% } %>

  <section class="panel mission-management-panel" id="admin-missions">
    <header class="panel-header">
      <div>
        <h2>Mission management</h2>
        <p class="panel-subtitle">Overview of every mission and its assets.</p>
      </div>
      <button type="button" class="button" data-open-mission-form>Create mission</button>
    </header>
    <div class="table-wrapper">
      <table class="missions-table">
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Bottles</th>
            <th scope="col">Turtles</th>
            <th scope="col">Boats</th>
            <th scope="col">Hubs</th>
            <th scope="col">Status</th>
          </tr>
        </thead>
        <tbody>
          <% missions.forEach(function (mission) { %>
            <% const missionEditData = {
                 id: mission.mission_id,
                 name: mission.name,
                 description: mission.description || '',
                 status: mission.status || 'planned',
                 startDate: formatDateTimeLocalValue(mission.start_date),
                 endDate: formatDateTimeLocalValue(mission.end_date),
                 targetLat: mission.target_lat ?? '',
                 targetLng: mission.target_lng ?? ''
               }; %>
            <tr
              role="button"
              tabindex="0"
              aria-label="Edit mission <%= mission.name || '#' + mission.mission_id %>"
              data-mission-row
              data-mission="<%= encodeRecord(missionEditData) %>"
            >
              <td data-label="Name">
                <strong><%= mission.name %></strong>
                <% if (mission.description) { %>
                  <div class="muted"><%= mission.description %></div>
                <% } %>
              </td>
              <td data-label="Bottles" class="numeric-cell"><%= mission.bottle_count ?? 0 %></td>
              <td data-label="Turtles" class="numeric-cell"><%= mission.turtle_count ?? 0 %></td>
              <td data-label="Boats" class="numeric-cell"><%= mission.boat_count ?? 0 %></td>
              <td data-label="Hubs" class="numeric-cell"><%= mission.hub_count ?? 0 %></td>
              <td data-label="Status">
                <div
                  class="inline-select"
                  role="button"
                  tabindex="0"
                  data-editable-select
                  data-edit-action="mission"
                  data-endpoint="/api/missions/<%= mission.mission_id %>"
                  data-field="status"
                  data-value="<%= mission.status %>"
                  data-options="planned|active|paused|completed"
                  data-label="Update status for mission <%= mission.name %>"
                  title="Click to change status"
                >
                  <span class="status-pill mission-status" data-status="<%= mission.status %>"><%= mission.status %></span>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% if (missions.length === 0) { %>
      <p class="panel-empty">No missions have been created yet.</p>
    <% } %>
  </section>

  <section class="panel turtle-management-panel" id="admin-turtles">
    <header class="panel-header">
      <div>
        <h2>Turtle management</h2>
        <p class="panel-subtitle">Assignments and telemetry coverage for every turtle.</p>
      </div>
      <button type="button" class="button" data-open-turtle-form>+ Add Turtle</button>
    </header>
    <div class="table-wrapper">
      <table class="turtles-table">
        <thead>
          <tr>
            <th scope="col">Profile</th>
            <th scope="col">Hub</th>
            <th scope="col">Bottles</th>
            <th scope="col">Manager</th>
            <th scope="col">Last update</th>
            <th scope="col">Logs</th>
            <th scope="col">Status</th>
          </tr>
        </thead>
        <tbody>
          <% turtlesForManagement.forEach(function (turtle) { %>
            <tr
              role="button"
              tabindex="0"
              aria-label="Manage turtle <%= turtle.name || '#' + turtle.turtle_id %>"
              data-manageable-turtle
              data-turtle-id="<%= turtle.turtle_id %>"
              data-turtle-name="<%= turtle.name || '' %>"
              data-turtle-status="<%= turtle.status || '' %>"
              data-turtle-mission="<%= turtle.mission_id || '' %>"
              data-turtle-hub="<%= turtle.hub_id || '' %>"
              data-turtle-hub-name="<%= turtle.hub_name || '' %>"
              data-turtle-boat="<%= turtle.boat_id || '' %>"
              data-turtle-photo-url="<%= turtle.profile_photo_url || turtle.profile_photo_thumbnail_url || '' %>"
              data-turtle-photo-thumb-url="<%= turtle.profile_photo_thumbnail_url || '' %>"
              data-bottles-endpoint="/api/turtles/<%= turtle.turtle_id %>/bottles"
            >
              <td data-label="Profile">
                <div class="turtle-profile">
                  <div class="turtle-profile__photo">
                    <div class="turtle-profile__badge">
                      <span class="turtle-profile__badge-id">#<%= turtle.turtle_id %></span>
                      <% if (turtle.name) { %>
                        <span class="turtle-profile__badge-name"><%= turtle.name %></span>
                      <% } %>
                    </div>
                    <% const turtleDisplayPhoto = turtle.profile_photo_thumbnail_url || turtle.profile_photo_url; %>
                    <% if (turtleDisplayPhoto) { %>
                      <img
                        src="<%= turtleDisplayPhoto %>"
                        alt="Profile photo for <%= turtle.name || '#' + turtle.turtle_id %>"
                        loading="lazy"
                      />
                    <% } else { %>
                      <span class="turtle-profile__placeholder-text">#<%= turtle.turtle_id %></span>
                    <% } %>
                  </div>
                </div>
              </td>
              <td data-label="Hub"><%= turtle.hub_name || 'â€”' %></td>
              <td data-label="Bottles" class="numeric-cell">
                <button
                  type="button"
                  class="status-pill turtle-bottles-pill"
                  data-trigger-manage-bottles
                  aria-label="View bottles linked to <%= turtle.name || 'turtle #' + turtle.turtle_id %>"
                >
                  <span aria-hidden="true">ðŸ”—</span>
                  <span><%= Number(turtle.bottle_count || 0).toLocaleString() %></span>
                </button>
              </td>
              <td data-label="Manager"><%= turtle.manager_name || 'â€”' %></td>
              <td data-label="Last update"><%= formatDateTime(turtle.last_update) %></td>
              <td data-label="Logs" class="numeric-cell"><%= turtle.log_count ?? 0 %></td>
              <td data-label="Status">
                <div
                  class="inline-select"
                  role="button"
                  tabindex="0"
                  data-editable-select
                  data-endpoint="/api/turtles/<%= turtle.turtle_id %>"
                  data-field="status"
                  data-value="<%= turtle.status || '' %>"
                  data-options="<%= turtleStatusOptions.join('|') %>"
                  data-label="Update status for turtle <%= turtle.name || '#' + turtle.turtle_id %>"
                  data-placeholder="Set status"
                  data-display-transform="turtle-status"
                  title="Click to change status"
                >
                  <span class="status-pill turtle-status-pill" data-status="<%= formatStatusKey(turtle.status) %>">
                    <%= formatTurtleStatus(turtle.status) %>
                  </span>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% if (turtlesForManagement.length === 0) { %>
      <p class="panel-empty">No turtles registered yet.</p>
    <% } %>
  </section>

  <%- include('partials/manage-turtle-dialog', { turtleStatusOptions, missions, hubs, boats }) %>

  <dialog id="turtleBottlesDialog" class="mission-dialog" aria-labelledby="turtleBottlesTitle">
    <article class="form-card turtle-bottles-card">
      <header class="mission-dialog__header">
        <div>
          <h2 id="turtleBottlesTitle">Connected bottles</h2>
          <p class="panel-subtitle" data-turtle-bottles-summary></p>
        </div>
        <button type="button" class="dialog-close" data-close-turtle-bottles aria-label="Close">&times;</button>
      </header>
      <p class="form-feedback" role="status" data-turtle-bottles-feedback hidden></p>
      <ul class="turtle-bottles-list" data-turtle-bottles-list></ul>
      <p class="panel-empty" data-turtle-bottles-empty hidden>
        No bottles are currently connected to this turtle.
      </p>
    </article>
  </dialog>

  <dialog id="createTurtleDialog" class="mission-dialog" aria-labelledby="createTurtleTitle">
    <form
      class="form-card admin-form turtle-form"
      data-endpoint="/api/turtles"
      data-method="POST"
      enctype="multipart/form-data"
    >
      <header class="mission-dialog__header">
        <div>
          <h2 id="createTurtleTitle">Add turtle</h2>
          <p class="panel-subtitle">Register a new Hope Turtle and link its mission context.</p>
        </div>
        <button type="button" class="dialog-close" data-close-turtle-form aria-label="Close">&times;</button>
      </header>
      <div class="mission-form-grid">
        <label class="full-width">
          Turtle name
          <input name="name" required />
        </label>
        <label>
          Status
          <select name="status">
            <% turtleStatusOptions.forEach(function (status) { %>
              <option value="<%= status %>"><%= status %></option>
            <% }) %>
          </select>
        </label>
        <label>
          Mission
          <select name="mission_id">
            <option value="">No mission assigned</option>
            <% missions.forEach(function (mission) { %>
              <option value="<%= mission.mission_id %>"><%= mission.name %></option>
            <% }) %>
          </select>
        </label>
        <label>
          Hub
          <select name="hub_id">
            <option value="">No hub assigned</option>
            <% hubs.forEach(function (hub) { %>
              <option value="<%= hub.hub_id %>"><%= hub.name %></option>
            <% }) %>
          </select>
        </label>
        <label>
          Boat
          <select name="boat_id">
            <option value="">No boat assigned</option>
            <% boats.forEach(function (boat) { %>
              <option value="<%= boat.boat_id %>"><%= boat.name %></option>
            <% }) %>
          </select>
        </label>
        <label class="full-width">
          Turtle manager
          <select name="turtle_manager">
            <option value="">No manager assigned</option>
            <% boatManagerOptions.forEach(function (user) { %>
              <option value="<%= user.buwana_id %>"><%= user.full_name || user.email || user.buwana_id %></option>
            <% }) %>
          </select>
        </label>
        <label class="full-width">
          Profile photo
          <input type="file" name="profile_photo" accept="image/*" />
        </label>
      </div>
      <div class="mission-dialog__actions">
        <button type="button" class="button ghost" data-close-turtle-form>Cancel</button>
        <button type="submit" class="button">Add turtle</button>
      </div>
      <p class="form-feedback" role="status"></p>
    </form>
  </dialog>

  <dialog id="createMissionDialog" class="mission-dialog" aria-labelledby="createMissionTitle">
    <form class="form-card admin-form mission-form" data-endpoint="/api/missions" data-method="POST">
      <header class="mission-dialog__header">
        <div>
          <h2 id="createMissionTitle">Create mission</h2>
          <p class="panel-subtitle">Define a new HopeTurtles deployment.</p>
        </div>
      </header>
      <div class="mission-form-grid">
        <label class="full-width">
          Name
          <input name="name" required />
        </label>
        <label class="full-width">
          Description
          <textarea name="description" rows="3"></textarea>
        </label>
        <label>
          Status
          <select name="status">
            <option value="planned">planned</option>
            <option value="active">active</option>
            <option value="paused">paused</option>
            <option value="completed">completed</option>
          </select>
        </label>
        <label>
          Start date
          <input type="datetime-local" name="start_date" />
        </label>
        <label>
          End date
          <input type="datetime-local" name="end_date" />
        </label>
        <label>
          Target latitude
          <input type="number" step="0.000001" name="target_lat" />
        </label>
        <label>
          Target longitude
          <input type="number" step="0.000001" name="target_lng" />
        </label>
      </div>
      <div class="mission-dialog__actions">
        <button type="button" class="button ghost" data-close-mission-form>Cancel</button>
        <button type="submit" class="button">Create mission</button>
      </div>
      <p class="form-feedback" role="status"></p>
    </form>
  </dialog>

  <dialog id="editMissionDialog" class="mission-dialog" aria-labelledby="editMissionTitle">
    <form class="form-card admin-form mission-form" data-edit-mission-form>
      <header class="mission-dialog__header">
        <div>
          <h2 id="editMissionTitle">Edit mission</h2>
          <p class="panel-subtitle">Update details for <span data-mission-name>this mission</span>.</p>
        </div>
        <button type="button" class="dialog-close" data-close-edit-mission-form aria-label="Close">&times;</button>
      </header>
      <div class="mission-form-grid">
        <label class="full-width">
          Name
          <input name="name" required />
        </label>
        <label class="full-width">
          Description
          <textarea name="description" rows="3"></textarea>
        </label>
        <label>
          Status
          <select name="status">
            <option value="planned">planned</option>
            <option value="active">active</option>
            <option value="paused">paused</option>
            <option value="completed">completed</option>
          </select>
        </label>
        <label>
          Start date
          <input type="datetime-local" name="start_date" />
        </label>
        <label>
          End date
          <input type="datetime-local" name="end_date" />
        </label>
        <label>
          Target latitude
          <input type="number" step="0.000001" name="target_lat" />
        </label>
        <label>
          Target longitude
          <input type="number" step="0.000001" name="target_lng" />
        </label>
      </div>
      <div class="mission-dialog__actions">
        <button type="button" class="button ghost" data-close-edit-mission-form>Cancel</button>
        <button type="submit" class="button">Save mission</button>
      </div>
      <p class="form-feedback" role="status"></p>
    </form>
  </dialog>

  <dialog id="createHubDialog" class="hub-dialog" aria-labelledby="createHubTitle">
    <form class="form-card admin-form hub-form" data-endpoint="/api/hubs" data-method="POST">
      <header class="mission-dialog__header">
        <div>
          <h2 id="createHubTitle">Create hub</h2>
          <p class="panel-subtitle">Add a new project hub to collect, receive and prepare bottles and hope turtles.</p>
        </div>
      </header>
      <div class="mission-form-grid">
        <label class="full-width">
          Name
          <input name="name" required />
        </label>
        <label class="full-width">
          Mission
          <select name="mission_id">
            <option value="">No mission connected</option>
            <% missions.forEach(function (mission) { %>
              <option value="<%= mission.mission_id %>"><%= mission.name %></option>
            <% }) %>
          </select>
        </label>
        <label class="full-width">
          Country
          <input name="country" />
        </label>
        <label class="full-width">
          Region
          <input name="region" />
        </label>
        <label class="full-width">
          Status
          <select name="status">
            <option value="Loading and Receiving">Loading and Receiving</option>
            <option value="Loading but not Receiving">Loading but not Receiving</option>
            <option value="Paused">Paused</option>
            <option value="Aborted">Aborted</option>
            <option value="Mission complete">Mission complete</option>
          </select>
        </label>
        <label class="full-width">
          Special instructions
          <textarea name="description" rows="3"></textarea>
        </label>
        <label class="full-width">
          Mailing address
          <textarea name="mailing_address" rows="3"></textarea>
        </label>
        <label class="full-width">
          Coordinator
          <select name="coordinator_id">
            <option value="">No coordinator assigned</option>
            <% users.forEach(function (user) { %>
              <option value="<%= user.buwana_id %>"><%= user.full_name || user.email || user.buwana_id %></option>
            <% }) %>
          </select>
        </label>
      </div>
      <div class="mission-dialog__actions">
        <button type="button" class="button ghost" data-close-hub-form>Cancel</button>
        <button type="submit" class="button">Create hub</button>
      </div>
      <p class="form-feedback" role="status"></p>
    </form>
  </dialog>

  <dialog id="editHubDialog" class="hub-dialog" aria-labelledby="editHubTitle">
    <form class="form-card admin-form hub-form" data-edit-hub-form>
      <header class="mission-dialog__header">
        <div>
          <h2 id="editHubTitle">Edit hub</h2>
          <p class="panel-subtitle">Update details for <span data-hub-name>this hub</span>.</p>
        </div>
        <button type="button" class="dialog-close" data-close-edit-hub-form aria-label="Close">&times;</button>
      </header>
      <div class="mission-form-grid">
        <label class="full-width">
          Name
          <input name="name" required />
        </label>
        <label class="full-width">
          Mission
          <select name="mission_id">
            <option value="">No mission connected</option>
            <% missions.forEach(function (mission) { %>
              <option value="<%= mission.mission_id %>"><%= mission.name %></option>
            <% }) %>
          </select>
        </label>
        <label class="full-width">
          Country
          <input name="country" />
        </label>
        <label class="full-width">
          Region
          <input name="region" />
        </label>
        <label class="full-width">
          Status
          <select name="status">
            <option value="Loading and Receiving">Loading and Receiving</option>
            <option value="Loading but not Receiving">Loading but not Receiving</option>
            <option value="Paused">Paused</option>
            <option value="Aborted">Aborted</option>
            <option value="Mission complete">Mission complete</option>
          </select>
        </label>
        <label class="full-width">
          Special instructions
          <textarea name="description" rows="3"></textarea>
        </label>
        <label class="full-width">
          Mailing address
          <textarea name="mailing_address" rows="3"></textarea>
        </label>
        <label class="full-width">
          Coordinator
          <select name="coordinator_id">
            <option value="">No coordinator assigned</option>
            <% users.forEach(function (user) { %>
              <option value="<%= user.buwana_id %>"><%= user.full_name || user.email || user.buwana_id %></option>
            <% }) %>
          </select>
        </label>
      </div>
      <div class="mission-dialog__actions">
        <button type="button" class="button ghost" data-close-edit-hub-form>Cancel</button>
        <button type="submit" class="button">Save hub</button>
      </div>
      <p class="form-feedback" role="status"></p>
    </form>
  </dialog>

  <section class="panel hub-management-panel" id="admin-hubs">
    <header class="panel-header">
      <div>
        <h2>Hub management</h2>
        <p class="panel-subtitle">Connected hubs with their linked missions and assets.</p>
      </div>
      <button type="button" class="button" data-open-hub-form>+ Add Hub</button>
    </header>
    <div class="table-wrapper">
      <table class="hubs-table">
        <thead>
          <tr>
            <th scope="col">Hub name</th>
            <th scope="col">Mission</th>
            <th scope="col">Country</th>
            <th scope="col">Boats</th>
            <th scope="col">Bottles</th>
            <th scope="col">Turtles</th>
            <th scope="col">Status</th>
          </tr>
        </thead>
        <tbody>
          <% hubs.forEach(function (hub) { %>
            <% const hubEditData = {
                 id: hub.hub_id,
                 name: hub.name,
                 missionId: hub.mission_id ?? '',
                 country: hub.country || '',
                 region: hub.region || '',
                 status: hub.status || '',
                 description: hub.description || '',
                 mailingAddress: hub.mailing_address || '',
                 coordinatorId: hub.coordinator_id ?? ''
               }; %>
            <tr
              role="button"
              tabindex="0"
              aria-label="Edit hub <%= hub.name || '#' + hub.hub_id %>"
              data-hub-row
              data-hub="<%= encodeRecord(hubEditData) %>"
            >
              <td data-label="Hub name">
                <strong><%= hub.name %></strong>
                <% if (hub.region) { %>
                  <div class="muted"><%= hub.region %></div>
                <% } %>
              </td>
              <td data-label="Mission"><%= hub.mission_name || 'â€”' %></td>
              <td data-label="Country"><%= hub.country || 'â€”' %></td>
              <td data-label="Boats" class="numeric-cell"><%= hub.boat_count ?? 0 %></td>
              <td data-label="Bottles" class="numeric-cell"><%= hub.bottle_count ?? 0 %></td>
              <td data-label="Turtles" class="numeric-cell"><%= hub.turtle_count ?? 0 %></td>
              <td data-label="Status">
                <div
                  class="inline-select"
                  role="button"
                  tabindex="0"
                  data-editable-select
                  data-edit-action="hub"
                  data-endpoint="/api/hubs/<%= hub.hub_id %>"
                  data-field="status"
                  data-value="<%= hub.status || '' %>"
                  data-options="Loading and Receiving|Loading but not Receiving|Paused|Aborted|Mission complete"
                  data-label="Update status for hub <%= hub.name %>"
                  data-placeholder="Set status"
                  title="Click to change status"
                >
                  <span class="status-pill hub-status" data-status="<%= formatStatusKey(hub.status) %>">
                    <%= hub.status || 'Set status' %>
                  </span>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% if (hubs.length === 0) { %>
      <p class="panel-empty">No hubs have been created yet.</p>
    <% } %>
  </section>

  

  

  <dialog id="createBoatDialog" class="boat-dialog" aria-labelledby="createBoatTitle">
    <form class="form-card admin-form boat-form" data-endpoint="/api/boats" data-method="POST">
      <header class="mission-dialog__header">
        <div>
          <h2 id="createBoatTitle">Add boat</h2>
          <p class="panel-subtitle">Register a vessel and connect it with missions and hubs.</p>
        </div>
      </header>
      <div class="mission-form-grid">
        <label class="full-width">
          Boat name
          <input name="name" required />
        </label>
        <label class="full-width">
          Mission
          <select name="mission_id">
            <option value="">No mission assigned</option>
            <% missions.forEach(function (mission) { %>
              <option value="<%= mission.mission_id %>"><%= mission.name %></option>
            <% }) %>
          </select>
        </label>
        <label class="full-width">
          Hub
          <select name="hub_id">
            <option value="">No hub assigned</option>
            <% hubs.forEach(function (hub) { %>
              <option value="<%= hub.hub_id %>"><%= hub.name %></option>
            <% }) %>
          </select>
        </label>
        <label class="full-width">
          Boat manager
          <select name="boat_manager">
            <option value="">No manager assigned</option>
            <% users.forEach(function (user) { %>
              <option value="<%= user.buwana_id %>"><%= user.full_name || user.email || user.buwana_id %></option>
            <% }) %>
          </select>
        </label>
        <label class="full-width">
          Boat owner
          <input name="owner" />
        </label>
        <label class="full-width">
          Registration
          <input name="registration" />
        </label>
        <label>
          Hope Turtle capacity
          <input type="number" step="0.01" min="0" name="capacity_hts" />
        </label>
        <label>
          People capacity
          <input type="number" step="0.01" min="0" name="capacity_persons" />
        </label>
        <label>
          Bottle capacity
          <input type="number" step="0.01" min="0" name="capacity_bottles" />
        </label>
        <label class="full-width">
          Contact information
          <input name="contact" />
        </label>
        <label class="full-width">
          Status
          <select name="status">
            <% boatStatuses.forEach(function (status) { %>
              <option value="<%= status %>" <%= status === defaultBoatStatus ? 'selected' : '' %>><%= status %></option>
            <% }) %>
          </select>
        </label>
      </div>
      <div class="mission-dialog__actions">
        <button type="button" class="button ghost" data-close-boat-form>Cancel</button>
        <button type="submit" class="button">Add boat</button>
      </div>
      <p class="form-feedback" role="status"></p>
    </form>
  </dialog>

  <dialog id="editBoatDialog" class="boat-dialog" aria-labelledby="editBoatTitle">
    <form class="form-card admin-form boat-form" data-edit-boat-form>
      <header class="mission-dialog__header">
        <div>
          <h2 id="editBoatTitle">Edit boat</h2>
          <p class="panel-subtitle">Update details for <span data-boat-name>this boat</span>.</p>
        </div>
        <button type="button" class="dialog-close" data-close-edit-boat-form aria-label="Close">&times;</button>
      </header>
      <div class="mission-form-grid">
        <label class="full-width">
          Boat name
          <input name="name" required />
        </label>
        <label class="full-width">
          Mission
          <select name="mission_id">
            <option value="">No mission assigned</option>
            <% missions.forEach(function (mission) { %>
              <option value="<%= mission.mission_id %>"><%= mission.name %></option>
            <% }) %>
          </select>
        </label>
        <label class="full-width">
          Hub
          <select name="hub_id">
            <option value="">No hub assigned</option>
            <% hubs.forEach(function (hub) { %>
              <option value="<%= hub.hub_id %>"><%= hub.name %></option>
            <% }) %>
          </select>
        </label>
        <label class="full-width">
          Boat owner
          <input name="owner" />
        </label>
        <label class="full-width">
          Registration
          <input name="registration" />
        </label>
        <label>
          Hope Turtle capacity
          <input type="number" step="0.01" min="0" name="capacity_hts" />
        </label>
        <label>
          People capacity
          <input type="number" step="0.01" min="0" name="capacity_persons" />
        </label>
        <label>
          Bottle capacity
          <input type="number" step="0.01" min="0" name="capacity_bottles" />
        </label>
        <label class="full-width">
          Contact information
          <input name="contact" />
        </label>
        <label class="full-width">
          Status
          <select name="status">
            <% boatStatuses.forEach(function (status) { %>
              <option value="<%= status %>"><%= status %></option>
            <% }) %>
          </select>
        </label>
      </div>
      <div class="mission-dialog__actions">
        <button type="button" class="button ghost" data-close-edit-boat-form>Cancel</button>
        <button type="submit" class="button">Save boat</button>
      </div>
      <p class="form-feedback" role="status"></p>
    </form>
  </dialog>

  <section class="panel boat-management-panel" id="admin-boats">
    <header class="panel-header">
      <div>
        <h2>Boat management</h2>
        <p class="panel-subtitle">Track every vessel, its deployment status and assignments.</p>
      </div>
      <button type="button" class="button" data-open-boat-form>+ Add boat</button>
    </header>
    <div class="admin-table table-wrapper">
      <table class="boats-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Owner</th>
            <th>HT capacity</th>
            <th>People capacity</th>
            <th>Bottle capacity</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <% boats.forEach(function (boat) { %>
            <% const boatEditData = {
                 id: boat.boat_id,
                 name: boat.name,
                 missionId: boat.mission_id ?? '',
                 hubId: boat.hub_id ?? '',
                 owner: boat.owner || '',
                 registration: boat.registration || '',
                 capacityHts: boat.capacity_hts ?? '',
                 capacityPersons: boat.capacity_persons ?? '',
                 capacityBottles: boat.capacity_bottles ?? '',
                 contact: boat.contact || '',
                 status: boat.status || defaultBoatStatus
               }; %>
            <tr
              role="button"
              tabindex="0"
              aria-label="Edit boat <%= boat.name || '#' + boat.boat_id %>"
              data-boat-row
              data-boat="<%= encodeRecord(boatEditData) %>"
            >
              <td><%= boat.boat_id %></td>
              <td>
                <strong><%= boat.name %></strong>
                <% if (boat.mission_name) { %>
                  <div class="muted">Mission: <%= boat.mission_name %></div>
                <% } %>
                <% if (boat.hub_name) { %>
                  <div class="muted">Hub: <%= boat.hub_name %></div>
                <% } %>
              </td>
              <td><%= boat.owner || 'â€”' %></td>
              <td class="numeric-cell"><%= formatWholeNumber(boat.capacity_hts) %></td>
              <td class="numeric-cell"><%= formatWholeNumber(boat.capacity_persons) %></td>
              <td class="numeric-cell"><%= formatWholeNumber(boat.capacity_bottles) %></td>
              <td>
                <div
                  class="inline-select"
                  role="button"
                  tabindex="0"
                  data-editable-select
                  data-edit-action="boat"
                  data-endpoint="/api/boats/<%= boat.boat_id %>"
                  data-field="status"
                  data-value="<%= boat.status || defaultBoatStatus %>"
                  data-options="<%= boatStatuses.join('|') %>"
                  data-label="Update status for boat <%= boat.name || '#' + boat.boat_id %>"
                  title="Click to change status"
                >
                  <span class="status-pill" data-status="<%= formatStatusKey(boat.status) %>">
                    <%= boat.status || defaultBoatStatus %>
                  </span>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% if (boats.length === 0) { %>
      <p class="panel-empty">No boats have been registered yet.</p>
    <% } %>
  </section>

  <section class="panel alert-management-panel" id="admin-alerts">
    <header class="panel-header">
      <div>
        <h2>Alert management</h2>
        <p class="panel-subtitle">Broadcast mission-critical notices to every dashboard.</p>
      </div>
    </header>
    <div class="admin-table table-wrapper">
      <table class="alerts-table">
        <thead>
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Title</th>
            <th scope="col">Status</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% adminAlerts.forEach(function (alert) { %>
            <tr>
              <td data-label="ID">#<%= alert.alert_id %></td>
              <td data-label="Title">
                <strong><%= alert.title %></strong>
                <% if (alert.message_body) { %>
                  <div class="muted"><%= alert.message_body %></div>
                <% } %>
              </td>
              <td data-label="Status">
                <div
                  class="inline-select"
                  role="button"
                  tabindex="0"
                  data-editable-select
                  data-endpoint="/api/alerts/<%= alert.alert_id %>"
                  data-field="status"
                  data-value="<%= alert.status %>"
                  data-options="active|off|archived"
                  data-label="Update status for alert <%= alert.title %>"
                  title="Click to change status"
                >
                  <span class="status-pill alert-status-pill" data-status="<%= alert.status %>">
                    <%= alert.status %>
                  </span>
                </div>
              </td>
              <td data-label="Actions">
                <button
                  class="button ghost delete"
                  data-endpoint="/api/alerts/<%= alert.alert_id %>"
                >
                  Delete
                </button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% if (adminAlerts.length === 0) { %>
      <p class="panel-empty">No alerts have been created yet.</p>
    <% } %>
    <form class="form-card admin-form" data-endpoint="/api/alerts" data-method="POST">
      <label>
        Title
        <input name="title" required />
      </label>
      <label>
        Emoji
        <input name="emoji" />
      </label>
      <label class="full-width">
        Message
        <textarea name="message_body" rows="3" required></textarea>
      </label>
      <div class="mission-dialog__actions">
        <button type="submit" class="button">Create alert</button>
      </div>
      <p class="form-feedback" role="status"></p>
    </form>
  </section>
</main>
<% const pageScripts = ['/js/admin.js', '/js/managed-turtles.js']; %>
<%- include('partials/footer', { pageScripts }) %>

<%- include('partials/header', { pageTitle, theme }) %>
<%- include('partials/nav') %>
<% const formatStatusKey = (value) => (value ? value.toLowerCase().replace(/[^a-z0-9]+/gu, '-') : ''); %>
<% const defaultBoatStatus = 'Docked'; %>
<% const boatStatuses = [
  'Docked',
  'Deployed',
  'Deploying',
  'Sailing',
  'Loading',
  'Distress',
  'Captured',
  'Sunk'
]; %>
<main id="main" class="layout admin">
  <section class="page-header">
    <h1>Admin Tools</h1>
    <p>Manage missions, turtles, hubs, boats, and alerts.</p>
  </section>

  <section class="panel mission-management-panel" id="admin-missions">
    <header class="panel-header">
      <div>
        <h2>Mission management</h2>
        <p class="panel-subtitle">Overview of every mission and its assets.</p>
      </div>
      <button type="button" class="button" data-open-mission-form>Create mission</button>
    </header>
    <div class="table-wrapper">
      <table class="missions-table">
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Status</th>
            <th scope="col">Bottles</th>
            <th scope="col">Turtles</th>
            <th scope="col">Boats</th>
            <th scope="col">Hubs</th>
          </tr>
        </thead>
        <tbody>
          <% missions.forEach(function (mission) { %>
            <tr>
              <td data-label="Name">
                <strong><%= mission.name %></strong>
                <% if (mission.description) { %>
                  <div class="muted"><%= mission.description %></div>
                <% } %>
              </td>
              <td data-label="Status">
                <div
                  class="inline-select"
                  role="button"
                  tabindex="0"
                  data-editable-select
                  data-endpoint="/api/missions/<%= mission.mission_id %>"
                  data-field="status"
                  data-value="<%= mission.status %>"
                  data-options="planned|active|paused|completed"
                  data-label="Update status for mission <%= mission.name %>"
                  title="Click to change status"
                >
                  <span class="status-pill mission-status" data-status="<%= mission.status %>"><%= mission.status %></span>
                </div>
              </td>
              <td data-label="Bottles" class="numeric-cell"><%= mission.bottle_count ?? 0 %></td>
              <td data-label="Turtles" class="numeric-cell"><%= mission.turtle_count ?? 0 %></td>
              <td data-label="Boats" class="numeric-cell"><%= mission.boat_count ?? 0 %></td>
              <td data-label="Hubs" class="numeric-cell"><%= mission.hub_count ?? 0 %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% if (missions.length === 0) { %>
      <p class="panel-empty">No missions have been created yet.</p>
    <% } %>
  </section>

  <dialog id="createMissionDialog" class="mission-dialog" aria-labelledby="createMissionTitle">
    <form class="form-card admin-form mission-form" data-endpoint="/api/missions" data-method="POST">
      <header class="mission-dialog__header">
        <div>
          <h2 id="createMissionTitle">Create mission</h2>
          <p class="panel-subtitle">Define a new HopeTurtles deployment.</p>
        </div>
      </header>
      <div class="mission-form-grid">
        <label class="full-width">
          Name
          <input name="name" required />
        </label>
        <label class="full-width">
          Description
          <textarea name="description" rows="3"></textarea>
        </label>
        <label>
          Status
          <select name="status">
            <option value="planned">planned</option>
            <option value="active">active</option>
            <option value="paused">paused</option>
            <option value="completed">completed</option>
          </select>
        </label>
        <label>
          Start date
          <input type="datetime-local" name="start_date" />
        </label>
        <label>
          End date
          <input type="datetime-local" name="end_date" />
        </label>
        <label>
          Target latitude
          <input type="number" step="0.000001" name="target_lat" />
        </label>
        <label>
          Target longitude
          <input type="number" step="0.000001" name="target_lng" />
        </label>
      </div>
      <div class="mission-dialog__actions">
        <button type="button" class="button ghost" data-close-mission-form>Cancel</button>
        <button type="submit" class="button">Create mission</button>
      </div>
      <p class="form-feedback" role="status"></p>
    </form>
  </dialog>

  <dialog id="createHubDialog" class="hub-dialog" aria-labelledby="createHubTitle">
    <form class="form-card admin-form hub-form" data-endpoint="/api/hubs" data-method="POST">
      <header class="mission-dialog__header">
        <div>
          <h2 id="createHubTitle">Create hub</h2>
          <p class="panel-subtitle">Add a new project hub to collect, receive and prepare bottles and hope turtles.</p>
        </div>
      </header>
      <div class="mission-form-grid">
        <label class="full-width">
          Name
          <input name="name" required />
        </label>
        <label class="full-width">
          Mission
          <select name="mission_id">
            <option value="">No mission connected</option>
            <% missions.forEach(function (mission) { %>
              <option value="<%= mission.mission_id %>"><%= mission.name %></option>
            <% }) %>
          </select>
        </label>
        <label class="full-width">
          Country
          <input name="country" />
        </label>
        <label class="full-width">
          Region
          <input name="region" />
        </label>
        <label class="full-width">
          Status
          <select name="status">
            <option value="Loading and Receiving">Loading and Receiving</option>
            <option value="Loading but not Receiving">Loading but not Receiving</option>
            <option value="Paused">Paused</option>
            <option value="Aborted">Aborted</option>
            <option value="Mission complete">Mission complete</option>
          </select>
        </label>
        <label class="full-width">
          Special instructions
          <textarea name="description" rows="3"></textarea>
        </label>
        <label class="full-width">
          Mailing address
          <textarea name="mailing_address" rows="3"></textarea>
        </label>
        <label class="full-width">
          Coordinator
          <select name="coordinator_id">
            <option value="">No coordinator assigned</option>
            <% users.forEach(function (user) { %>
              <option value="<%= user.buwana_id %>"><%= user.full_name || user.email || user.buwana_id %></option>
            <% }) %>
          </select>
        </label>
      </div>
      <div class="mission-dialog__actions">
        <button type="button" class="button ghost" data-close-hub-form>Cancel</button>
        <button type="submit" class="button">Create hub</button>
      </div>
      <p class="form-feedback" role="status"></p>
    </form>
  </dialog>

  <section class="panel hub-management-panel" id="admin-hubs">
    <header class="panel-header">
      <div>
        <h2>Hub management</h2>
        <p class="panel-subtitle">Connected hubs with their linked missions and assets.</p>
      </div>
      <button type="button" class="button" data-open-hub-form>+ Add Hub</button>
    </header>
    <div class="table-wrapper">
      <table class="hubs-table">
        <thead>
          <tr>
            <th scope="col">Hub name</th>
            <th scope="col">Mission</th>
            <th scope="col">Country</th>
            <th scope="col">Boats</th>
            <th scope="col">Bottles</th>
            <th scope="col">Turtles</th>
            <th scope="col">Status</th>
          </tr>
        </thead>
        <tbody>
          <% hubs.forEach(function (hub) { %>
            <tr>
              <td data-label="Hub name">
                <strong><%= hub.name %></strong>
                <% if (hub.region) { %>
                  <div class="muted"><%= hub.region %></div>
                <% } %>
              </td>
              <td data-label="Mission"><%= hub.mission_name || '—' %></td>
              <td data-label="Country"><%= hub.country || '—' %></td>
              <td data-label="Boats" class="numeric-cell"><%= hub.boat_count ?? 0 %></td>
              <td data-label="Bottles" class="numeric-cell"><%= hub.bottle_count ?? 0 %></td>
              <td data-label="Turtles" class="numeric-cell"><%= hub.turtle_count ?? 0 %></td>
              <td data-label="Status">
                <div
                  class="inline-select"
                  role="button"
                  tabindex="0"
                  data-editable-select
                  data-endpoint="/api/hubs/<%= hub.hub_id %>"
                  data-field="status"
                  data-value="<%= hub.status || '' %>"
                  data-options="Loading and Receiving|Loading but not Receiving|Paused|Aborted|Mission complete"
                  data-label="Update status for hub <%= hub.name %>"
                  data-placeholder="Set status"
                  title="Click to change status"
                >
                  <span class="status-pill hub-status" data-status="<%= formatStatusKey(hub.status) %>">
                    <%= hub.status || 'Set status' %>
                  </span>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% if (hubs.length === 0) { %>
      <p class="panel-empty">No hubs have been created yet.</p>
    <% } %>
  </section>

  <dialog id="turtleSecretDialog" class="mission-dialog" aria-labelledby="turtleSecretTitle" hidden>
    <div class="form-card admin-form">
      <header class="mission-dialog__header">
        <div>
          <h2 id="turtleSecretTitle">Hopeturtle secret key</h2>
          <p class="panel-subtitle">Share this secret only with the Hopeturtle it belongs to.</p>
        </div>
        <button type="button" class="dialog-close" data-close-secret aria-label="Close">&times;</button>
      </header>
      <div class="mission-form-grid">
        <p class="full-width">
          In order to ensure secure communications and accurate telemetry, we have a secret key for every Hopeturtle.
          Please copy your hopeturtle's secret key and install it in the <code>serviced/secret_key.txt</code> file on your HopeTurtles OS.
          Keep the key safe so no one else has access.
        </p>
        <p class="full-width">
          Secret for <strong data-turtle-name>your Hopeturtle</strong>:
        </p>
        <div class="full-width secret-key-card">
          <pre class="secret-key-value" data-turtle-secret></pre>
          <button type="button" class="button ghost" data-copy-secret>Copy secret</button>
        </div>
        <p class="copy-feedback full-width muted" data-copy-feedback role="status" aria-live="polite"></p>
      </div>
      <div class="mission-dialog__actions">
        <button type="button" class="button" data-close-secret>Done</button>
      </div>
    </div>
  </dialog>

  <section class="admin-section" id="admin-turtles">
    <h2>Turtles</h2>
    <form class="form-card admin-form" data-endpoint="/api/turtles" data-method="POST">
      <label>Name <input name="name" required /></label>
      <label>Status
        <select name="status">
          <option value="idle">idle</option>
          <option value="en_route">en_route</option>
          <option value="arrived">arrived</option>
          <option value="lost">lost</option>
        </select>
      </label>
      <label>Mission ID <input type="number" name="mission_id" /></label>
      <button type="submit" class="button">Create turtle</button>
      <p class="form-feedback" role="status"></p>
    </form>
    <div class="admin-table">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% turtles.forEach(function (turtle) { %>
            <tr>
              <td><%= turtle.turtle_id %></td>
              <td><%= turtle.name %></td>
              <td><%= turtle.status %></td>
              <td>
                <button
                  class="button ghost delete"
                  data-endpoint="/api/turtles/<%= turtle.turtle_id %>"
                >
                  Delete
                </button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </section>

  <section class="admin-section" id="admin-hubs-form">
    <h2>Hubs</h2>
    <form class="form-card admin-form" data-endpoint="/api/hubs" data-method="POST">
      <label>Name <input name="name" required /></label>
      <label>Mission
        <select name="mission_id">
          <option value="">No mission connected</option>
          <% missions.forEach(function (mission) { %>
            <option value="<%= mission.mission_id %>"><%= mission.name %></option>
          <% }) %>
        </select>
      </label>
      <label>Country <input name="country" /></label>
      <label>Region <input name="region" /></label>
      <label>Status
        <select name="status">
          <option value="Loading and Receiving">Loading and Receiving</option>
          <option value="Loading but not Receiving">Loading but not Receiving</option>
          <option value="Paused">Paused</option>
          <option value="Aborted">Aborted</option>
          <option value="Mission complete">Mission complete</option>
        </select>
      </label>
      <label>Special instructions <textarea name="description" rows="3"></textarea></label>
      <label>Mailing address <textarea name="mailing_address" rows="3"></textarea></label>
      <label>Coordinator
        <select name="coordinator_id">
          <option value="">No coordinator assigned</option>
          <% users.forEach(function (user) { %>
            <option value="<%= user.buwana_id %>"><%= user.full_name || user.email || user.buwana_id %></option>
          <% }) %>
        </select>
      </label>
      <button type="submit" class="button">Create hub</button>
      <p class="form-feedback" role="status"></p>
    </form>
    <div class="admin-table">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Country</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% hubs.forEach(function (hub) { %>
            <tr>
              <td><%= hub.hub_id %></td>
              <td><%= hub.name %></td>
              <td><%= hub.country %></td>
              <td>
                <button
                  class="button ghost delete"
                  data-endpoint="/api/hubs/<%= hub.hub_id %>"
                >
                  Delete
                </button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </section>

  <dialog id="createBoatDialog" class="boat-dialog" aria-labelledby="createBoatTitle">
    <form class="form-card admin-form boat-form" data-endpoint="/api/boats" data-method="POST">
      <header class="mission-dialog__header">
        <div>
          <h2 id="createBoatTitle">Add boat</h2>
          <p class="panel-subtitle">Register a vessel and connect it with missions and hubs.</p>
        </div>
      </header>
      <div class="mission-form-grid">
        <label class="full-width">
          Boat name
          <input name="name" required />
        </label>
        <label class="full-width">
          Mission
          <select name="mission_id">
            <option value="">No mission assigned</option>
            <% missions.forEach(function (mission) { %>
              <option value="<%= mission.mission_id %>"><%= mission.name %></option>
            <% }) %>
          </select>
        </label>
        <label class="full-width">
          Hub
          <select name="hub_id">
            <option value="">No hub assigned</option>
            <% hubs.forEach(function (hub) { %>
              <option value="<%= hub.hub_id %>"><%= hub.name %></option>
            <% }) %>
          </select>
        </label>
        <label class="full-width">
          Boat manager
          <select name="boat_manager">
            <option value="">No manager assigned</option>
            <% users.forEach(function (user) { %>
              <option value="<%= user.buwana_id %>"><%= user.full_name || user.email || user.buwana_id %></option>
            <% }) %>
          </select>
        </label>
        <label class="full-width">
          Boat owner
          <input name="owner" />
        </label>
        <label class="full-width">
          Registration
          <input name="registration" />
        </label>
        <label>
          Hope Turtle capacity
          <input type="number" step="0.01" min="0" name="capacity_hts" />
        </label>
        <label>
          People capacity
          <input type="number" step="0.01" min="0" name="capacity_persons" />
        </label>
        <label>
          Bottle capacity
          <input type="number" step="0.01" min="0" name="capacity_bottles" />
        </label>
        <label class="full-width">
          Contact information
          <input name="contact" />
        </label>
        <label class="full-width">
          Status
          <select name="status">
            <% boatStatuses.forEach(function (status) { %>
              <option value="<%= status %>" <%= status === defaultBoatStatus ? 'selected' : '' %>><%= status %></option>
            <% }) %>
          </select>
        </label>
      </div>
      <div class="mission-dialog__actions">
        <button type="button" class="button ghost" data-close-boat-form>Cancel</button>
        <button type="submit" class="button">Add boat</button>
      </div>
      <p class="form-feedback" role="status"></p>
    </form>
  </dialog>

  <section class="panel boat-management-panel" id="admin-boats">
    <header class="panel-header">
      <div>
        <h2>Boat management</h2>
        <p class="panel-subtitle">Track every vessel, its deployment status and assignments.</p>
      </div>
      <button type="button" class="button" data-open-boat-form>+ Add boat</button>
    </header>
    <div class="admin-table table-wrapper">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Owner</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% boats.forEach(function (boat) { %>
            <tr>
              <td><%= boat.boat_id %></td>
              <td><%= boat.name %></td>
              <td><%= boat.owner %></td>
              <td>
                <button
                  class="button ghost delete"
                  data-endpoint="/api/boats/<%= boat.boat_id %>"
                >
                  Delete
                </button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% if (boats.length === 0) { %>
      <p class="panel-empty">No boats have been registered yet.</p>
    <% } %>
  </section>

  <section class="admin-section" id="admin-alerts">
    <h2>Alerts</h2>
    <form class="form-card admin-form" data-endpoint="/api/alerts" data-method="POST">
      <label>Title <input name="title" required /></label>
      <label>Message <textarea name="message_body" required></textarea></label>
      <label>Emoji <input name="emoji" /></label>
      <button type="submit" class="button">Create alert</button>
      <p class="form-feedback" role="status"></p>
    </form>
    <div class="admin-table">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% alerts.forEach(function (alert) { %>
            <tr>
              <td><%= alert.alert_id %></td>
              <td><%= alert.title %></td>
              <td><%= alert.status %></td>
              <td>
                <button
                  class="button ghost delete"
                  data-endpoint="/api/alerts/<%= alert.alert_id %>"
                >
                  Delete
                </button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </section>
</main>
<% const pageScripts = ['/js/admin.js']; %>
<%- include('partials/footer', { pageScripts }) %>
